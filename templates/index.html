<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Dart Scorer</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <h1>AI Dart Scorer</h1>

    <input type="file" id="fileInput" accept="image/*" />
    <button id="runDetection" type="button" disabled>Run detection</button>
    <div class="overlay-options" role="group" aria-label="Overlay options">
      <span>Overlays</span>
      <label>
        <input type="checkbox" id="overlayPoints" checked />
        Points
      </label>
      <label>
        <input type="checkbox" id="overlayLines" />
        Lines
      </label>
      <label>
        <input type="checkbox" id="overlayCircles" />
        Circles
      </label>
    </div>
    <div class="preview-row">
      <div class="preview-wrap">
        <img id="preview" class="preview-img" alt="Selected image preview" />
      </div>
      <div class="preview-wrap">
        <img id="overlay" class="preview-img" alt="Overlay preview" />
      </div>
    </div>
    <script>
      const fileInput = document.getElementById("fileInput");
      const runDetection = document.getElementById("runDetection");
      const overlayPoints = document.getElementById("overlayPoints");
      const overlayLines = document.getElementById("overlayLines");
      const overlayCircles = document.getElementById("overlayCircles");
      const preview = document.getElementById("preview");
      const overlay = document.getElementById("overlay");
      let previewUrl = null;
      let selectedFile = null;

      function clearPreviews() {
        preview.style.display = "none";
        overlay.style.display = "none";
        preview.removeAttribute("src");
        overlay.removeAttribute("src");
        if (previewUrl) {
          URL.revokeObjectURL(previewUrl);
          previewUrl = null;
        }
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          selectedFile = null;
          runDetection.disabled = true;
          clearPreviews();
          return;
        }

        selectedFile = file;
        runDetection.disabled = false;
        if (previewUrl) {
          URL.revokeObjectURL(previewUrl);
        }
        previewUrl = URL.createObjectURL(file);
        preview.src = previewUrl;
        preview.style.display = "block";
        overlay.style.display = "none";
        overlay.removeAttribute("src");
      });

      function runDetectionRequest() {
        if (!selectedFile || runDetection.disabled) {
          return;
        }
        runDetection.disabled = true;
        const formData = new FormData();
        formData.append("file", selectedFile);
        const params = new URLSearchParams({
          points: overlayPoints.checked ? "1" : "0",
          lines: overlayLines.checked ? "1" : "0",
          circles: overlayCircles.checked ? "1" : "0",
        });
        fetch(`/keypoints?${params.toString()}`, { method: "POST", body: formData })
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              overlay.style.display = "none";
              overlay.removeAttribute("src");
              return;
            }
            if (!data.overlay) {
              overlay.style.display = "none";
              overlay.removeAttribute("src");
              return;
            }
            overlay.src = `data:image/png;base64,${data.overlay}`;
            overlay.style.display = "block";
          })
          .catch(() => {
            overlay.style.display = "none";
            overlay.removeAttribute("src");
          })
          .finally(() => {
            runDetection.disabled = false;
          });
      }

      runDetection.addEventListener("click", runDetectionRequest);
      [overlayPoints, overlayLines, overlayCircles].forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (!selectedFile) {
            return;
          }
          runDetectionRequest();
        });
      });
    </script>
  </body>
</html>
