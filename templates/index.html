<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Dart Scorer</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <h1>AI Dart Scorer</h1>

    <input type="file" id="fileInput" accept="image/*" />
    <button id="runDetection" type="button" disabled>Run detection</button>
    <div class="overlay-options" role="group" aria-label="Overlay options">
      <span>Overlays</span>
      <label>
        <input type="checkbox" id="overlayPoints" checked />
        Points
      </label>
      <label>
        <input type="checkbox" id="overlayLines" />
        Lines
      </label>
      <label>
        <input type="checkbox" id="overlayCircles" />
        Circles
      </label>
    </div>
    <div class="preview-row">
      <div class="preview-wrap">
        <img id="preview" class="preview-img" alt="Selected image preview" />
      </div>
      <div class="preview-wrap">
        <img id="overlay" class="preview-img" alt="Overlay preview" />
      </div>
    </div>
    <script>
      const fileInput = document.getElementById("fileInput");
      const runDetection = document.getElementById("runDetection");
      const overlayPoints = document.getElementById("overlayPoints");
      const overlayLines = document.getElementById("overlayLines");
      const overlayCircles = document.getElementById("overlayCircles");
      const preview = document.getElementById("preview");
      const overlay = document.getElementById("overlay");
      const state = { previewUrl: null, file: null };

      function hideImage(img) {
        img.style.display = "none";
        img.removeAttribute("src");
      }

      function showImage(img, src) {
        img.src = src;
        img.style.display = "block";
      }

      function clearPreviews() {
        hideImage(preview);
        hideImage(overlay);
        if (state.previewUrl) {
          URL.revokeObjectURL(state.previewUrl);
          state.previewUrl = null;
        }
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          state.file = null;
          runDetection.disabled = true;
          clearPreviews();
          return;
        }

        state.file = file;
        runDetection.disabled = false;
        if (state.previewUrl) {
          URL.revokeObjectURL(state.previewUrl);
        }
        state.previewUrl = URL.createObjectURL(file);
        showImage(preview, state.previewUrl);
        hideImage(overlay);
      });

      async function runDetectionRequest() {
        if (!state.file || runDetection.disabled) {
          return;
        }
        runDetection.disabled = true;
        const formData = new FormData();
        formData.append("file", state.file);
        const params = new URLSearchParams({
          points: overlayPoints.checked,
          lines: overlayLines.checked,
          circles: overlayCircles.checked,
        });
        try {
          const response = await fetch(`/keypoints?${params.toString()}`, {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            hideImage(overlay);
            return;
          }
          const data = await response.json();
          if (!data || !data.overlay) {
            hideImage(overlay);
            return;
          }
          showImage(overlay, `data:image/png;base64,${data.overlay}`);
        } catch (error) {
          hideImage(overlay);
        } finally {
          runDetection.disabled = false;
        }
      }

      runDetection.addEventListener("click", runDetectionRequest);
      [overlayPoints, overlayLines, overlayCircles].forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          if (!state.file) {
            return;
          }
          runDetectionRequest();
        });
      });
    </script>
  </body>
</html>
