<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AI Dart Scorer</title>
    <link rel="stylesheet" href="/frontend/style.css" />
  </head>
  <body>
    <h1>AI Dart Scorer</h1>

    <input type="file" id="fileInput" accept="image/*" />
    <button id="runDetection" type="button" disabled>Run detection</button>
    <div class="preview-row">
      <div class="preview-wrap">
        <img id="preview" class="preview-img" alt="Selected image preview" />
      </div>
      <div class="preview-wrap">
        <img id="result" class="preview-img" alt="Processed image preview" />
      </div>
    </div>
    <script>
      const fileInput = document.getElementById("fileInput");
      const runDetection = document.getElementById("runDetection");
      const preview = document.getElementById("preview");
      const result = document.getElementById("result");
      const state = { previewUrl: null, file: null };

      function hideImage(img) {
        img.style.display = "none";
        img.removeAttribute("src");
      }

      function showImage(img, src) {
        img.src = src;
        img.style.display = "block";
      }

      function clearPreviews() {
        hideImage(preview);
        hideImage(result);
        if (state.previewUrl) {
          URL.revokeObjectURL(state.previewUrl);
          state.previewUrl = null;
        }
      }

      fileInput.addEventListener("change", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          state.file = null;
          runDetection.disabled = true;
          clearPreviews();
          return;
        }

        state.file = file;
        runDetection.disabled = false;
        if (state.previewUrl) {
          URL.revokeObjectURL(state.previewUrl);
        }
        state.previewUrl = URL.createObjectURL(file);
        showImage(preview, state.previewUrl);
        hideImage(result);
      });

      async function runDetectionRequest() {
        if (!state.file || runDetection.disabled) {
          return;
        }
        runDetection.disabled = true;
        const formData = new FormData();
        formData.append("file", state.file);
        try {
          const response = await fetch("/keypoints", {
            method: "POST",
            body: formData,
          });
          if (!response.ok) {
            hideImage(result);
            return;
          }
          const data = await response.json();
          if (!data || !data.image) {
            hideImage(result);
            return;
          }
          showImage(result, `data:image/png;base64,${data.image}`);
        } catch (error) {
          hideImage(result);
        } finally {
          runDetection.disabled = false;
        }
      }

      runDetection.addEventListener("click", runDetectionRequest);
    </script>
  </body>
</html>
